!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n;n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,n.RTM=t()}}(function(){var t;return function n(t,e,i){function r(s,a){if(!e[s]){if(!t[s]){var c="function"==typeof require&&require;if(!a&&c)return c(s,!0);if(o)return o(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var h=e[s]={exports:{}};t[s][0].call(h.exports,function(n){var e=t[s][1][n];return r(e?e:n)},h,h.exports,n,t,e,i)}return e[s].exports}for(var o="function"==typeof require&&require,s=0;s<i.length;s++)r(i[s]);return r}({1:[function(n,e,i){!function(n,r){"object"==typeof i?e.exports=i=r():"function"==typeof t&&t.amd?t([],r):n.CryptoJS=r()}(this,function(){var t=t||function(t,n){var e={},i=e.lib={},r=i.Base=function(){function t(){}return{extend:function(n){t.prototype=this;var e=new t;return n&&e.mixIn(n),e.hasOwnProperty("init")||(e.init=function(){e.$super.init.apply(this,arguments)}),e.init.prototype=e,e.$super=this,e},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var n in t)t.hasOwnProperty(n)&&(this[n]=t[n]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),o=i.WordArray=r.extend({init:function(t,e){t=this.words=t||[],e!=n?this.sigBytes=e:this.sigBytes=4*t.length},toString:function(t){return(t||a).stringify(this)},concat:function(t){var n=this.words,e=t.words,i=this.sigBytes,r=t.sigBytes;if(this.clamp(),i%4)for(var o=0;r>o;o++){var s=e[o>>>2]>>>24-o%4*8&255;n[i+o>>>2]|=s<<24-(i+o)%4*8}else for(var o=0;r>o;o+=4)n[i+o>>>2]=e[o>>>2];return this.sigBytes+=r,this},clamp:function(){var n=this.words,e=this.sigBytes;n[e>>>2]&=4294967295<<32-e%4*8,n.length=t.ceil(e/4)},clone:function(){var t=r.clone.call(this);return t.words=this.words.slice(0),t},random:function(n){for(var e,i=[],r=function(n){var n=n,e=987654321,i=4294967295;return function(){e=36969*(65535&e)+(e>>16)&i,n=18e3*(65535&n)+(n>>16)&i;var r=(e<<16)+n&i;return r/=4294967296,r+=.5,r*(t.random()>.5?1:-1)}},s=0;n>s;s+=4){var a=r(4294967296*(e||t.random()));e=987654071*a(),i.push(4294967296*a()|0)}return new o.init(i,n)}}),s=e.enc={},a=s.Hex={stringify:function(t){for(var n=t.words,e=t.sigBytes,i=[],r=0;e>r;r++){var o=n[r>>>2]>>>24-r%4*8&255;i.push((o>>>4).toString(16)),i.push((15&o).toString(16))}return i.join("")},parse:function(t){for(var n=t.length,e=[],i=0;n>i;i+=2)e[i>>>3]|=parseInt(t.substr(i,2),16)<<24-i%8*4;return new o.init(e,n/2)}},c=s.Latin1={stringify:function(t){for(var n=t.words,e=t.sigBytes,i=[],r=0;e>r;r++){var o=n[r>>>2]>>>24-r%4*8&255;i.push(String.fromCharCode(o))}return i.join("")},parse:function(t){for(var n=t.length,e=[],i=0;n>i;i++)e[i>>>2]|=(255&t.charCodeAt(i))<<24-i%4*8;return new o.init(e,n)}},u=s.Utf8={stringify:function(t){try{return decodeURIComponent(escape(c.stringify(t)))}catch(n){throw new Error("Malformed UTF-8 data")}},parse:function(t){return c.parse(unescape(encodeURIComponent(t)))}},h=i.BufferedBlockAlgorithm=r.extend({reset:function(){this._data=new o.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=u.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(n){var e=this._data,i=e.words,r=e.sigBytes,s=this.blockSize,a=4*s,c=r/a;c=n?t.ceil(c):t.max((0|c)-this._minBufferSize,0);var u=c*s,h=t.min(4*u,r);if(u){for(var f=0;u>f;f+=s)this._doProcessBlock(i,f);var p=i.splice(0,u);e.sigBytes-=h}return new o.init(p,h)},clone:function(){var t=r.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0}),f=(i.Hasher=h.extend({cfg:r.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){h.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){t&&this._append(t);var n=this._doFinalize();return n},blockSize:16,_createHelper:function(t){return function(n,e){return new t.init(e).finalize(n)}},_createHmacHelper:function(t){return function(n,e){return new f.HMAC.init(t,e).finalize(n)}}}),e.algo={});return e}(Math);return t})},{}],2:[function(n,e,i){!function(r,o){"object"==typeof i?e.exports=i=o(n("./core")):"function"==typeof t&&t.amd?t(["./core"],o):o(r.CryptoJS)}(this,function(t){return function(){var n=t,e=n.lib,i=e.WordArray,r=n.enc;r.Base64={stringify:function(t){var n=t.words,e=t.sigBytes,i=this._map;t.clamp();for(var r=[],o=0;e>o;o+=3)for(var s=n[o>>>2]>>>24-o%4*8&255,a=n[o+1>>>2]>>>24-(o+1)%4*8&255,c=n[o+2>>>2]>>>24-(o+2)%4*8&255,u=s<<16|a<<8|c,h=0;4>h&&e>o+.75*h;h++)r.push(i.charAt(u>>>6*(3-h)&63));var f=i.charAt(64);if(f)for(;r.length%4;)r.push(f);return r.join("")},parse:function(t){var n=t.length,e=this._map,r=e.charAt(64);if(r){var o=t.indexOf(r);-1!=o&&(n=o)}for(var s=[],a=0,c=0;n>c;c++)if(c%4){var u=e.indexOf(t.charAt(c-1))<<c%4*2,h=e.indexOf(t.charAt(c))>>>6-c%4*2,f=u|h;s[a>>>2]|=f<<24-a%4*8,a++}return i.create(s,a)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),t.enc.Base64})},{"./core":1}],3:[function(n,e,i){!function(r,o,s){"object"==typeof i?e.exports=i=o(n("./core"),n("./md5"),n("./hmac")):"function"==typeof t&&t.amd?t(["./core","./md5","./hmac"],o):o(r.CryptoJS)}(this,function(t){return t.HmacMD5})},{"./core":1,"./hmac":4,"./md5":5}],4:[function(n,e,i){!function(r,o){"object"==typeof i?e.exports=i=o(n("./core")):"function"==typeof t&&t.amd?t(["./core"],o):o(r.CryptoJS)}(this,function(t){!function(){var n=t,e=n.lib,i=e.Base,r=n.enc,o=r.Utf8,s=n.algo;s.HMAC=i.extend({init:function(t,n){t=this._hasher=new t.init,"string"==typeof n&&(n=o.parse(n));var e=t.blockSize,i=4*e;n.sigBytes>i&&(n=t.finalize(n)),n.clamp();for(var r=this._oKey=n.clone(),s=this._iKey=n.clone(),a=r.words,c=s.words,u=0;e>u;u++)a[u]^=1549556828,c[u]^=909522486;r.sigBytes=s.sigBytes=i,this.reset()},reset:function(){var t=this._hasher;t.reset(),t.update(this._iKey)},update:function(t){return this._hasher.update(t),this},finalize:function(t){var n=this._hasher,e=n.finalize(t);n.reset();var i=n.finalize(this._oKey.clone().concat(e));return i}})}()})},{"./core":1}],5:[function(n,e,i){!function(r,o){"object"==typeof i?e.exports=i=o(n("./core")):"function"==typeof t&&t.amd?t(["./core"],o):o(r.CryptoJS)}(this,function(t){return function(n){function e(t,n,e,i,r,o,s){var a=t+(n&e|~n&i)+r+s;return(a<<o|a>>>32-o)+n}function i(t,n,e,i,r,o,s){var a=t+(n&i|e&~i)+r+s;return(a<<o|a>>>32-o)+n}function r(t,n,e,i,r,o,s){var a=t+(n^e^i)+r+s;return(a<<o|a>>>32-o)+n}function o(t,n,e,i,r,o,s){var a=t+(e^(n|~i))+r+s;return(a<<o|a>>>32-o)+n}var s=t,a=s.lib,c=a.WordArray,u=a.Hasher,h=s.algo,f=[];!function(){for(var t=0;64>t;t++)f[t]=4294967296*n.abs(n.sin(t+1))|0}();var p=h.MD5=u.extend({_doReset:function(){this._hash=new c.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(t,n){for(var s=0;16>s;s++){var a=n+s,c=t[a];t[a]=16711935&(c<<8|c>>>24)|4278255360&(c<<24|c>>>8)}var u=this._hash.words,h=t[n+0],p=t[n+1],l=t[n+2],d=t[n+3],y=t[n+4],b=t[n+5],v=t[n+6],g=t[n+7],w=t[n+8],_=t[n+9],m=t[n+10],S=t[n+11],k=t[n+12],j=t[n+13],x=t[n+14],E=t[n+15],O=u[0],I=u[1],M=u[2],C=u[3];O=e(O,I,M,C,h,7,f[0]),C=e(C,O,I,M,p,12,f[1]),M=e(M,C,O,I,l,17,f[2]),I=e(I,M,C,O,d,22,f[3]),O=e(O,I,M,C,y,7,f[4]),C=e(C,O,I,M,b,12,f[5]),M=e(M,C,O,I,v,17,f[6]),I=e(I,M,C,O,g,22,f[7]),O=e(O,I,M,C,w,7,f[8]),C=e(C,O,I,M,_,12,f[9]),M=e(M,C,O,I,m,17,f[10]),I=e(I,M,C,O,S,22,f[11]),O=e(O,I,M,C,k,7,f[12]),C=e(C,O,I,M,j,12,f[13]),M=e(M,C,O,I,x,17,f[14]),I=e(I,M,C,O,E,22,f[15]),O=i(O,I,M,C,p,5,f[16]),C=i(C,O,I,M,v,9,f[17]),M=i(M,C,O,I,S,14,f[18]),I=i(I,M,C,O,h,20,f[19]),O=i(O,I,M,C,b,5,f[20]),C=i(C,O,I,M,m,9,f[21]),M=i(M,C,O,I,E,14,f[22]),I=i(I,M,C,O,y,20,f[23]),O=i(O,I,M,C,_,5,f[24]),C=i(C,O,I,M,x,9,f[25]),M=i(M,C,O,I,d,14,f[26]),I=i(I,M,C,O,w,20,f[27]),O=i(O,I,M,C,j,5,f[28]),C=i(C,O,I,M,l,9,f[29]),M=i(M,C,O,I,g,14,f[30]),I=i(I,M,C,O,k,20,f[31]),O=r(O,I,M,C,b,4,f[32]),C=r(C,O,I,M,w,11,f[33]),M=r(M,C,O,I,S,16,f[34]),I=r(I,M,C,O,x,23,f[35]),O=r(O,I,M,C,p,4,f[36]),C=r(C,O,I,M,y,11,f[37]),M=r(M,C,O,I,g,16,f[38]),I=r(I,M,C,O,m,23,f[39]),O=r(O,I,M,C,j,4,f[40]),C=r(C,O,I,M,h,11,f[41]),M=r(M,C,O,I,d,16,f[42]),I=r(I,M,C,O,v,23,f[43]),O=r(O,I,M,C,_,4,f[44]),C=r(C,O,I,M,k,11,f[45]),M=r(M,C,O,I,E,16,f[46]),I=r(I,M,C,O,l,23,f[47]),O=o(O,I,M,C,h,6,f[48]),C=o(C,O,I,M,g,10,f[49]),M=o(M,C,O,I,x,15,f[50]),I=o(I,M,C,O,b,21,f[51]),O=o(O,I,M,C,k,6,f[52]),C=o(C,O,I,M,d,10,f[53]),M=o(M,C,O,I,m,15,f[54]),I=o(I,M,C,O,p,21,f[55]),O=o(O,I,M,C,w,6,f[56]),C=o(C,O,I,M,E,10,f[57]),M=o(M,C,O,I,v,15,f[58]),I=o(I,M,C,O,j,21,f[59]),O=o(O,I,M,C,y,6,f[60]),C=o(C,O,I,M,S,10,f[61]),M=o(M,C,O,I,l,15,f[62]),I=o(I,M,C,O,_,21,f[63]),u[0]=u[0]+O|0,u[1]=u[1]+I|0,u[2]=u[2]+M|0,u[3]=u[3]+C|0},_doFinalize:function(){var t=this._data,e=t.words,i=8*this._nDataBytes,r=8*t.sigBytes;e[r>>>5]|=128<<24-r%32;var o=n.floor(i/4294967296),s=i;e[(r+64>>>9<<4)+15]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),e[(r+64>>>9<<4)+14]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),t.sigBytes=4*(e.length+1),this._process();for(var a=this._hash,c=a.words,u=0;4>u;u++){var h=c[u];c[u]=16711935&(h<<8|h>>>24)|4278255360&(h<<24|h>>>8)}return a},clone:function(){var t=u.clone.call(this);return t._hash=this._hash.clone(),t}});s.MD5=u._createHelper(p),s.HmacMD5=u._createHmacHelper(p)}(Math),t.MD5})},{"./core":1}],6:[function(t,n,e){"use strict";function i(t){if(null===t||void 0===t)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(t)}function r(){try{if(!Object.assign)return!1;var t=new String("abc");if(t[5]="de","5"===Object.getOwnPropertyNames(t)[0])return!1;for(var n={},e=0;10>e;e++)n["_"+String.fromCharCode(e)]=e;var i=Object.getOwnPropertyNames(n).map(function(t){return n[t]});if("0123456789"!==i.join(""))return!1;var r={};return"abcdefghijklmnopqrst".split("").forEach(function(t){r[t]=t}),"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},r)).join("")?!1:!0}catch(o){return!1}}var o=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable;n.exports=r()?Object.assign:function(t,n){for(var e,r,a=i(t),c=1;c<arguments.length;c++){e=Object(arguments[c]);for(var u in e)o.call(e,u)&&(a[u]=e[u]);if(Object.getOwnPropertySymbols){r=Object.getOwnPropertySymbols(e);for(var h=0;h<r.length;h++)s.call(e,r[h])&&(a[r[h]]=e[r[h]])}}return a}},{}],7:[function(t,n,e){function i(t,n){var e=h(t,n);return f.stringify(e)}function r(t){clearTimeout(t.timerId),t.onsuccess()}function o(t,n){clearTimeout(t.timerId),t.onfail(n)}function s(t,n,e){n.rtm._unsafeSend(t,function(t){try{t.action.endsWith("/ok")?e(t):o(n,t)}catch(i){o(n,i)}})}function a(t,n){var e=i(n,t.roleSecret),o={action:"auth/authenticate",body:{method:l,credentials:{hash:e}}};s(o,t,r.bind(null,t))}function c(t){var n={action:"auth/handshake",body:{method:l,data:{role:t.role}}};s(n,t,function(n){var e=n.body.data.nonce;a(t,e)})}function u(t,n,e){var i={timeout:3e4};if("string"!=typeof t)throw new TypeError('"role" is missing or invalid');if("string"!=typeof n)throw new TypeError('"roleSecret" is missing or invalid');return function(r,s,a){var u=p(i,e,{rtm:r,role:t,handshakeReply:null,onsuccess:s,onfail:a,roleSecret:n}),h=setTimeout(function(){o(u,new Error("authentication timeout"))},u.timeout);u.timerId=h,c(u)}}var h=t("crypto-js/hmac-md5"),f=t("crypto-js/enc-base64"),p=t("object-assign"),l="role_secret";n.exports={hmacMd5:i,roleSecretAuthProvider:u}},{"crypto-js/enc-base64":2,"crypto-js/hmac-md5":3,"object-assign":6}],8:[function(t,n,e){var i=console&&console.log,r={DEBUG:!1,error:function(t){i&&(console.log.apply(console,arguments),t.stack&&console.log(t.stack))},warn:function(){i&&console.warn.apply(console,arguments)},debug:function(){r.DEBUG&&i&&console.log.apply(console,arguments)}};n.exports=r},{}],9:[function(t,n,e){var i;"undefined"!=typeof Map&&"forEach"in Map.prototype?n.exports=Map:(i=function(){this.storage={keys:[],values:[]},this.size=0},i.prototype.set=function(t,n){var e=this._index(t);e>=0?this.storage.values[e]=n:(this.storage.keys.push(t),this.storage.values.push(n)),this.size=this.storage.keys.length},i.prototype.get=function(t){var n=this._index(t);return n>=0?this.storage.values[n]:void 0},i.prototype["delete"]=function(t){var n=this._index(t);n>=0&&(this.storage.keys.splice(n,1),this.storage.values.splice(n,1)),this.size=this.storage.keys.length},i.prototype.clear=function(){this.storage.keys=[],this.storage.values=[],this.size=this.storage.keys.length},i.prototype._index=function(t){return this.storage.keys.indexOf(t)},n.exports=i)},{}],10:[function(t,n,e){function i(){this.handlers={}}var r=t("./logger.js");i.prototype={on:function(t,n){t in this.handlers||(this.handlers[t]=[]),this.handlers[t].push(n)},off:function(t,n){t in this.handlers&&(this.handlers[t]=this.handlers[t].filter(function(t){return t!==n}))},fire:function(t){var n=this.handlers[t]||[],e=Array.prototype.slice.call(arguments);e.shift(),n.forEach(function(t){try{t.apply(null,e)}catch(n){r.error(n)}})}},n.exports=i},{"./logger.js":8}],11:[function(t,n,e){function i(t,n,e){if("string"!=typeof t)throw new TypeError('"endpoint" is missing or invalid');if("string"!=typeof n)throw new TypeError('"appkey" is missing or invalid');o.call(this),this.options=u({minReconnectInterval:1e3,maxReconnectInterval:12e4,heartbeatInterval:6e4,heartbeatEnabled:!0,highWaterMark:4194304,lowWaterMark:2097152,checkWritabilityInterval:100},e),this.endpoint=this._appendVersion(t)+"?appkey="+n,this.reconnectCount=0,this.lastId=0,this.ws=null,this.reconnectTimer=null,this.subscriptions={},this.ackCallbacks=new h,this.maskMessage=!this._isEndpointSecure(t),this.options.heartbeatEnabled&&this._initHeartbeatInterval(),this.writable=!0,this._initWritableState(),this._initConnectionFSM(),this.on("error",a.error)}var r=t("./websocket.js"),o=t("./observer.js"),s=t("./subscription.js"),a=t("./logger.js"),c=t("./auth.js"),u=t("object-assign"),h=t("./map.js"),f="v2",p="stopped",l="connecting",d="connected",y="awaiting",b={};i.logger=a,i.SubscriptionMode={RELIABLE:{trackPosition:!0,fastForward:!0},SIMPLE:{trackPosition:!1,fastForward:!0},ADVANCED:{trackPosition:!0,fastForward:!1}},i.roleSecretAuthProvider=function(t,n,e){return c.roleSecretAuthProvider(t,n,e)},i.prototype=Object.create(o.prototype),i.prototype.start=function(){if(p!==this.state)throw new Error("RTM is already started");this.fire("start")},i.prototype.stop=function(){if(p===this.state)throw new Error("RTM is already stopped");this.fire("stop")},i.prototype.restart=function(){this.stop(),this.start()},i.prototype.isStopped=function(){return this.state===p},i.prototype.isConnected=function(){return this.state===d},i.prototype.getSubscription=function(t){if("string"!=typeof t)throw new TypeError('"subscriptionId" is missing or invalid');return this.subscriptions[t]},i.prototype.subscribe=function(t,n,e){var i,r,o,a=function(t,n){return n.reduce(function(n,e){return n&&{}.hasOwnProperty.call(t,e)},!0)},c=["fastForward","trackPosition"];if("string"!=typeof t)throw new TypeError('"channelOrSubId" is missing or invalid');if("object"!=typeof n||!a(n,c))throw new TypeError("Subscription mode has incorrect value: "+n+"\nMode should contains the following mandatory fields: "+c.join(", ")+"\nSee also: RTM.SubscriptionMode.SIMPLE, RTM.SubscriptionMode.ADVANCED, RTM.SubscriptionMode.RELIABLE");if(this.subscriptions[t])throw new Error("Cannot create subscription "+i+" twice");return o=u({},n,{bodyOpts:e}),i=new s(t,o),this.subscriptions[t]=i,this.isConnected()&&(r=i.subscribePdu(this._nextId()),this._send(r,function(t){i.onPdu(t)})),i},i.prototype.resubscribe=function(t,n,e,i){var r,o,s=this;if("string"!=typeof t)throw new TypeError('"channelOrSubId" is missing or invalid');r=s.subscriptions[t],s.unsubscribe(t,function(){o=s.subscribe(t,n,e),o.handlers=r.handlers,i&&i(o)})},i.prototype.unsubscribe=function(t,n){var e,i,r,o=this;if("string"!=typeof t)throw new TypeError('"subscriptionId" is missing or invalid');if(e=o.subscriptions[t],!e)throw new Error("Unknown subscription "+t);i=function(i){i&&e.onPdu(i),delete o.subscriptions[t],n&&n(i)},e.isSubscribed?(r=e.unsubscribePdu(o._nextId()),o._send(r,i)):i()},i.prototype.publish=function(t,n,e){var i;if("string"!=typeof t)throw new TypeError('"channel" is missing or invalid');if("undefined"==typeof n)throw new TypeError('"message" is missing');return i={action:"rtm/publish",body:{channel:t,message:n}},this._send(i,e)},i.prototype.read=function(t,n){var e,i;if("string"!=typeof t)throw new TypeError('"channel" is missing or invalid');return i="function"==typeof n?{onAck:n}:n,e={action:"rtm/read",body:u({},i.bodyOpts,{channel:t})},this._send(e,i.onAck)},i.prototype.write=function(t,n,e){var i;if("string"!=typeof t)throw new TypeError('"channel" is missing or invalid');if("undefined"==typeof n)throw new TypeError('"value" is missing or invalid');return i={action:"rtm/write",body:{channel:t,message:n}},this._send(i,e)},i.prototype["delete"]=function(t,n){var e;if("string"!=typeof t)throw new TypeError('"channel" is missing or invalid');return e={action:"rtm/delete",body:{channel:t}},this._send(e,n)},i.prototype.search=function(t,n){var e;if("string"!=typeof t)throw new TypeError('"prefix" is missing or invalid');return e={action:"rtm/search",body:{prefix:t}},this._send(e,n)},i.prototype._initHeartbeatInterval=function(){var t,n=this,e=this.options.heartbeatInterval;this.on("open",function(){var i=0,r=0;t=setInterval(function(){return i>r?void n._disconnect():(i=Date.now(),void n.publish("$heartbeat","",function(){r=Date.now()}))},e)}),this.on("close",function(){clearInterval(t)})},i.prototype._initWritableState=function(){var t,n=this,e=this.options.checkWritabilityInterval;this.on("open",function(){n._setWritableState(!0),t=setInterval(function(){n._checkWritableState()},e)}),this.on("close",function(){clearInterval(t),n._setWritableState(!1)})},i.prototype._checkWritableState=function(){this.writable&&this.ws.bufferedAmount>this.options.highWaterMark?this._setWritableState(!1):!this.writable&&this.ws.bufferedAmount<this.options.lowWaterMark&&this._setWritableState(!0)},i.prototype._setWritableState=function(t){this.writable!==t&&(this.writable=t,this.fire("change-writability",this.writable))},i.prototype._connect=function(){var t,n=this;a.debug("Connecting to",this.endpoint),t=this.ws=new r(this.endpoint,[],{perMessageDeflate:!1}),t.onopen=function(){n.fire("open")},t.onmessage=function(t){var e;try{a.debug("recv<",t.data),e=JSON.parse(t.data),n._recv(e),n.fire("data",e)}catch(i){n.fire("error",i)}},t.onerror=function(t){n.fire("error",t)},t.onclose=function(){n.ws===t&&(n.ws=null,n.fire("close"))}},i.prototype._send=function(t,n){if(!this.isConnected())throw new Error("Client is not connected");return this._unsafeSend(t,n)},i.prototype._unsafeSend=function(t,n){var e,i=u({},t);n&&(i.id="id"in i?i.id:this._nextId(),this.ackCallbacks.set(i.id,n)),e=JSON.stringify(i),a.debug("send>",e);try{this.ws.send(e,{mask:this.maskMessage})}catch(r){this.fire("error",r)}this._checkWritableState()},i.prototype._recv=function(t){var n,e,i,r=function(t,n){return t.substr(0,n.length)===n},o=function(t,n){return-1!==t.indexOf(n,t.length-n.length)};t.body&&"subscription_id"in t.body&&r(t.action,"rtm/subscription/")&&(n=t.body.subscription_id,e=this.subscriptions[n],e&&e.onPdu(t)),"id"in t&&(i=this.ackCallbacks.get(t.id),i&&(o(t.action,"/data")||this.ackCallbacks["delete"](t.id),i(t)))},i.prototype._disconnect=function(){var t=this.ws;t&&(t.onclose(),t.onclose=null,t.close()),this.ackCallbacks.clear()},i.prototype._nextId=function(){return this.lastId+=1,this.lastId},i.prototype._nextReconnectInterval=function(){var t=30,n=this.options.minReconnectInterval,e=this.options.maxReconnectInterval,i=Math.random()*this.options.minReconnectInterval,r=Math.min(this.reconnectCount,t),o=Math.min(e,i+n*Math.pow(2,r));return o},i.prototype._forEachSubscription=function(t){var n=this;Object.keys(n.subscriptions).forEach(function(e){({}).hasOwnProperty.call(n.subscriptions,e)&&t(e,n.subscriptions[e])})},i.prototype._subscribeAll=function(){var t=this;this._forEachSubscription(function(n,e){var i=e.subscribePdu(t._nextId());t._send(i,function(t){e.onPdu(t)})})},i.prototype._disconnectAll=function(){this._forEachSubscription(function(t,n){n.onDisconnect()})},i.prototype._isEndpointSecure=function(t){return 0===t.indexOf("wss://")?!0:!1},b[p]={_enter:function(){this._disconnect()},_leave:function(){},start:function(){this._transition(l)},close:function(){}},b[l]={_enter:function(){try{this._connect()}catch(t){this.fire("error",t)}},_leave:function(){},open:function(){var t,n,e=this;this.lastId=0,this.options.authProvider?(t=function(){e.fire("authenticated"),e._transition(d)},n=function(t){e.fire("error",t)},this.options.authProvider(this,t,n)):this._transition(d)},error:function(){this._transition(y)},close:function(){this._transition(y)},stop:function(){this._transition(p)}},b[d]={_enter:function(){this.reconnectCount=0,this._subscribeAll()},_leave:function(){this._disconnectAll()},close:function(){this._transition(y)},stop:function(){this._transition(p)}},b[y]={_enter:function(){var t,n=this;this._disconnect(),t=this._nextReconnectInterval(),this.reconnectTimer=setTimeout(function(){n.reconnectCount+=1,n._transition(l)},t)},_leave:function(){null!==this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.reconnectTimer=null},stop:function(){this._transition(p)},close:function(){}},i.prototype._initConnectionFSM=function(){var t=this,n=["open","close","error","start","stop","reconnect"];this._transition(p),n.forEach(function(n){t.on(n,function(){t._safelyCallFSMEvent(n)})})},i.prototype._safelyCallFSMEvent=function(t){var n=b[this.state][t];if(a.debug("FSM event:",t,"Current state:",this.state),n)try{n.call(this)}catch(e){a.error(e,"Unexpected error during event callback call",this.state,t)}else a.warn("Nothing to do for event",t,this.state)},i.prototype._transition=function(t){a.debug("Transition from",this.state,"to",t),this.state&&(this._safelyCallFSMEvent("_leave"),this.fire("leave-"+this.state)),this.state=t,this._safelyCallFSMEvent("_enter"),this.fire("enter-"+this.state)},i.prototype._appendVersion=function(t){var n,e=t.match(/\/(v\d+)$/),i=t;return null!==e?(n=e[1],a.warn("satori-sdk-js: specifying RTM endpoint with protocol version is deprecated.\nsatori-sdk-js: please remove version '"+n+"' from endpoint:'"+t+"'"),i):("/"!==i[i.length-1]&&(i+="/"),i+f)},n.exports=i},{"./auth.js":7,"./logger.js":8,"./map.js":9,"./observer.js":10,"./subscription.js":12,"./websocket.js":13,"object-assign":6}],12:[function(t,n,e){function i(t,n){if("string"!=typeof t)throw new TypeError('"subscriptionId" is missing or invalid');r.call(this),this.options=o({},n),"object"!=typeof this.options.bodyOpts&&(this.options.bodyOpts={}),this.options.fastForward&&(this.options.bodyOpts.fast_forward=!0),this.position=null,this.subscriptionId=t,this.wasSubscribedAtLeastOnce=!1,this.isSubscribed=!1}var r=t("./observer.js"),o=t("object-assign");i.prototype=Object.create(r.prototype),i.prototype.subscribePdu=function(t){var n;return n=this.options.bodyOpts.filter?{subscription_id:this.subscriptionId}:{channel:this.subscriptionId},n=o(n,this.options.bodyOpts),this.wasSubscribedAtLeastOnce&&(null!==this.position?n.position=this.position:delete n.position),{id:t,action:"rtm/subscribe",body:n}},i.prototype.unsubscribePdu=function(t){return{id:t,action:"rtm/unsubscribe",body:{subscription_id:this.subscriptionId}}},i.prototype.onPdu=function(t){var n=t.body;n&&n.position&&this._onPosition(n.position),"rtm/subscribe/ok"===t.action&&(this.isSubscribed=!0,this.wasSubscribedAtLeastOnce=!0,this.fire("enter-subscribed")),"rtm/unsubscribe/ok"===t.action&&this._markAsUnsubscribed(),"rtm/subscription/error"===t.action&&this._markAsUnsubscribed(),this.fire("data",t,this),this.fire(t.action,t,this)},i.prototype.onDisconnect=function(){this._markAsUnsubscribed()},i.prototype._onPosition=function(t){this.options.trackPosition&&(this.position=t),this.fire("position",t,this)},i.prototype._markAsUnsubscribed=function(){this.isSubscribed&&(this.isSubscribed=!1,this.fire("leave-subscribed"))},n.exports=i},{"./observer.js":10,"object-assign":6}],13:[function(t,n,e){function i(t){return new o(t)}var r=function(){return this}(),o=r.WebSocket||r.MozWebSocket;n.exports=o?i:null},{}]},{},[11])(11)});
//# sourceMappingURL=sdk.min.js.map
